databaseChangeLog:
  # ============================================================
  # ZONE TABLE
  # ============================================================
  - changeSet:
      id: 001-create-zone-table
      author: shamkhi
      changes:
        - createTable:
            tableName: zone
            columns:
              - column:
                  name: id
                  type: varchar(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: nom
                  type: varchar(100)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: code_postal
                  type: varchar(10)
                  constraints:
                    nullable: false
              - column:
                  name: ville
                  type: varchar(100)
              - column:
                  name: date_creation
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: date_modification
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP

  # ============================================================
  # CLIENT EXPEDITEUR TABLE
  # ============================================================
  - changeSet:
      id: 002-create-client-expediteur-table
      author: shamkhi
      changes:
        - createTable:
            tableName: client_expediteur
            columns:
              - column:
                  name: id
                  type: varchar(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: nom
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: prenom
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: email
                  type: varchar(150)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: telephone
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: adresse
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: date_creation
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: date_modification
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP

  # ============================================================
  # DESTINATAIRE TABLE
  # ============================================================
  - changeSet:
      id: 003-create-destinataire-table
      author: shamkhi
      changes:
        - createTable:
            tableName: destinataire
            columns:
              - column:
                  name: id
                  type: varchar(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: nom
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: prenom
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: email
                  type: varchar(150)
              - column:
                  name: telephone
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: adresse
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: date_creation
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: date_modification
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP

  # ============================================================
  # LIVREUR TABLE
  # ============================================================
  - changeSet:
      id: 004-create-livreur-table
      author: shamkhi
      changes:
        - createTable:
            tableName: livreur
            columns:
              - column:
                  name: id
                  type: varchar(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: nom
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: prenom
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: telephone
                  type: varchar(20)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: vehicule
                  type: varchar(100)
              - column:
                  name: actif
                  type: boolean
                  defaultValueBoolean: true
              - column:
                  name: zone_assignee_id
                  type: varchar(36)
              - column:
                  name: date_creation
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: date_modification
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP

        - addForeignKeyConstraint:
            baseTableName: livreur
            baseColumnNames: zone_assignee_id
            referencedTableName: zone
            referencedColumnNames: id
            constraintName: fk_livreur_zone
            onDelete: SET NULL

  # ============================================================
  # PRODUIT TABLE
  # ============================================================
  - changeSet:
      id: 005-create-produit-table
      author: shamkhi
      changes:
        - createTable:
            tableName: produit
            columns:
              - column:
                  name: id
                  type: varchar(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: nom
                  type: varchar(200)
                  constraints:
                    nullable: false
              - column:
                  name: categorie
                  type: varchar(100)
              - column:
                  name: poids
                  type: decimal(10,2)
                  constraints:
                    nullable: false
              - column:
                  name: prix
                  type: decimal(10,2)
                  constraints:
                    nullable: false
              - column:
                  name: date_creation
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: date_modification
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP

  # ============================================================
  # SECURITY TABLES
  # ============================================================
  - changeSet:
      id: 006-create-security-tables
      author: shamkhi
      changes:
        # Roles table
        - createTable:
            tableName: roles
            columns:
              - column:
                  name: id
                  type: VARCHAR(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: description
                  type: VARCHAR(255)

        # Permissions table
        - createTable:
            tableName: permissions
            columns:
              - column:
                  name: id
                  type: VARCHAR(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: description
                  type: VARCHAR(255)
              - column:
                  name: resource
                  type: VARCHAR(50)
              - column:
                  name: action
                  type: VARCHAR(50)

        # Users table
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: VARCHAR(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: username
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: email
                  type: VARCHAR(150)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: password
                  type: VARCHAR(255)
              - column:
                  name: nom
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: prenom
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: telephone
                  type: VARCHAR(20)
              - column:
                  name: actif
                  type: BOOLEAN
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: provider
                  type: VARCHAR(20)
                  defaultValue: 'LOCAL'
                  constraints:
                    nullable: false
              - column:
                  name: provider_id
                  type: VARCHAR(100)
              - column:
                  name: client_expediteur_id
                  type: VARCHAR(36)
              - column:
                  name: livreur_id
                  type: VARCHAR(36)
              - column:
                  name: date_creation
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: date_modification
                  type: TIMESTAMP

        # User-Role junction table
        - createTable:
            tableName: user_roles
            columns:
              - column:
                  name: user_id
                  type: VARCHAR(36)
                  constraints:
                    nullable: false
              - column:
                  name: role_id
                  type: VARCHAR(36)
                  constraints:
                    nullable: false

        - addPrimaryKey:
            tableName: user_roles
            columnNames: user_id, role_id
            constraintName: pk_user_roles

        # Role-Permission junction table
        - createTable:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  type: VARCHAR(36)
                  constraints:
                    nullable: false
              - column:
                  name: permission_id
                  type: VARCHAR(36)
                  constraints:
                    nullable: false

        - addPrimaryKey:
            tableName: role_permissions
            columnNames: role_id, permission_id
            constraintName: pk_role_permissions

        # Foreign keys for users
        - addForeignKeyConstraint:
            baseTableName: users
            baseColumnNames: client_expediteur_id
            referencedTableName: client_expediteur
            referencedColumnNames: id
            constraintName: fk_users_client_expediteur
            onDelete: SET NULL

        - addForeignKeyConstraint:
            baseTableName: users
            baseColumnNames: livreur_id
            referencedTableName: livreur
            referencedColumnNames: id
            constraintName: fk_users_livreur
            onDelete: SET NULL

        # Foreign keys for user_roles
        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: user_id
            constraintName: fk_user_roles_user
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: role_id
            constraintName: fk_user_roles_role
            referencedTableName: roles
            referencedColumnNames: id
            onDelete: CASCADE

        # Foreign keys for role_permissions
        - addForeignKeyConstraint:
            baseTableName: role_permissions
            baseColumnNames: role_id
            constraintName: fk_role_permissions_role
            referencedTableName: roles
            referencedColumnNames: id
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: role_permissions
            baseColumnNames: permission_id
            constraintName: fk_role_permissions_permission
            referencedTableName: permissions
            referencedColumnNames: id
            onDelete: CASCADE

        # Indexes for users
        - createIndex:
            tableName: users
            indexName: idx_users_username
            columns:
              - column:
                  name: username

        - createIndex:
            tableName: users
            indexName: idx_users_email
            columns:
              - column:
                  name: email

        - createIndex:
            tableName: users
            indexName: idx_users_client_expediteur
            columns:
              - column:
                  name: client_expediteur_id

        - createIndex:
            tableName: users
            indexName: idx_users_livreur
            columns:
              - column:
                  name: livreur_id

        - createIndex:
            tableName: users
            indexName: idx_users_provider_provider_id
            columns:
              - column:
                  name: provider
              - column:
                  name: provider_id

        - addUniqueConstraint:
            tableName: users
            columnNames: provider, provider_id
            constraintName: uk_users_provider_provider_id

  # ============================================================
  # COLIS TABLE
  # ============================================================
  - changeSet:
      id: 007-create-colis-table
      author: shamkhi
      changes:
        - createTable:
            tableName: colis
            columns:
              - column:
                  name: id
                  type: varchar(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: description
                  type: varchar(500)
                  constraints:
                    nullable: false
              - column:
                  name: poids
                  type: decimal(10,2)
                  constraints:
                    nullable: false
              - column:
                  name: statut
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: priorite
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: ville_destination
                  type: varchar(100)
                  constraints:
                    nullable: false
              - column:
                  name: date_limite_livraison
                  type: timestamp
              - column:
                  name: date_collecte
                  type: timestamp
              - column:
                  name: date_livraison
                  type: timestamp
              - column:
                  name: livreur_id
                  type: varchar(36)
              - column:
                  name: client_expediteur_id
                  type: varchar(36)
                  constraints:
                    nullable: false
              - column:
                  name: destinataire_id
                  type: varchar(36)
                  constraints:
                    nullable: false
              - column:
                  name: zone_id
                  type: varchar(36)
              - column:
                  name: date_creation
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
              - column:
                  name: date_modification
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP

        - addForeignKeyConstraint:
            baseTableName: colis
            baseColumnNames: livreur_id
            referencedTableName: livreur
            referencedColumnNames: id
            constraintName: fk_colis_livreur
            onDelete: SET NULL

        - addForeignKeyConstraint:
            baseTableName: colis
            baseColumnNames: client_expediteur_id
            referencedTableName: client_expediteur
            referencedColumnNames: id
            constraintName: fk_colis_client_expediteur
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: colis
            baseColumnNames: destinataire_id
            referencedTableName: destinataire
            referencedColumnNames: id
            constraintName: fk_colis_destinataire
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: colis
            baseColumnNames: zone_id
            referencedTableName: zone
            referencedColumnNames: id
            constraintName: fk_colis_zone
            onDelete: SET NULL

  # ============================================================
  # HISTORIQUE LIVRAISON TABLE
  # ============================================================
  - changeSet:
      id: 008-create-historique-livraison-table
      author: shamkhi
      changes:
        - createTable:
            tableName: historique_livraison
            columns:
              - column:
                  name: id
                  type: varchar(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: colis_id
                  type: varchar(36)
                  constraints:
                    nullable: false
              - column:
                  name: statut
                  type: varchar(20)
                  constraints:
                    nullable: false
              - column:
                  name: date_changement
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: commentaire
                  type: varchar(500)
              - column:
                  name: modifie_par
                  type: varchar(100)

        - addForeignKeyConstraint:
            baseTableName: historique_livraison
            baseColumnNames: colis_id
            referencedTableName: colis
            referencedColumnNames: id
            constraintName: fk_historique_colis
            onDelete: CASCADE

  # ============================================================
  # COLIS PRODUIT TABLE
  # ============================================================
  - changeSet:
      id: 009-create-colis-produit-table
      author: shamkhi
      changes:
        - createTable:
            tableName: colis_produit
            columns:
              - column:
                  name: id
                  type: varchar(36)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: colis_id
                  type: varchar(36)
                  constraints:
                    nullable: false
              - column:
                  name: produit_id
                  type: varchar(36)
                  constraints:
                    nullable: false
              - column:
                  name: quantite
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: prix
                  type: decimal(10,2)
                  constraints:
                    nullable: false
              - column:
                  name: date_ajout
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP

        - addForeignKeyConstraint:
            baseTableName: colis_produit
            baseColumnNames: colis_id
            referencedTableName: colis
            referencedColumnNames: id
            constraintName: fk_colis_produit_colis
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: colis_produit
            baseColumnNames: produit_id
            referencedTableName: produit
            referencedColumnNames: id
            constraintName: fk_colis_produit_produit
            onDelete: CASCADE

  # ============================================================
  # INDEXES
  # ============================================================
  - changeSet:
      id: 010-add-indexes
      author: shamkhi
      changes:
        - createIndex:
            indexName: idx_colis_statut
            tableName: colis
            columns:
              - column:
                  name: statut

        - createIndex:
            indexName: idx_colis_priorite
            tableName: colis
            columns:
              - column:
                  name: priorite

        - createIndex:
            indexName: idx_colis_ville_destination
            tableName: colis
            columns:
              - column:
                  name: ville_destination

        - createIndex:
            indexName: idx_colis_date_creation
            tableName: colis
            columns:
              - column:
                  name: date_creation

        - createIndex:
            indexName: idx_historique_date_changement
            tableName: historique_livraison
            columns:
              - column:
                  name: date_changement

  # ============================================================
  # INITIAL SECURITY DATA
  # ============================================================
  - changeSet:
      id: 011-init-security-data
      author: shamkhi
      changes:
        # Insert Roles
        - insert:
            tableName: roles
            columns:
              - column:
                  name: id
                  value: role-001
              - column:
                  name: name
                  value: ROLE_MANAGER
              - column:
                  name: description
                  value: Gestionnaire avec accès complet au système

        - insert:
            tableName: roles
            columns:
              - column:
                  name: id
                  value: role-002
              - column:
                  name: name
                  value: ROLE_LIVREUR
              - column:
                  name: description
                  value: Livreur avec accès limité aux colis assignés

        - insert:
            tableName: roles
            columns:
              - column:
                  name: id
                  value: role-003
              - column:
                  name: name
                  value: ROLE_CLIENT
              - column:
                  name: description
                  value: Client expéditeur avec accès à ses propres colis

        # Insert Permissions (continuing from previous...)
        - insert:
            tableName: permissions
            columns:
              - column:
                  name: id
                  value: perm-001
              - column:
                  name: name
                  value: READ_COLIS
              - column:
                  name: description
                  value: Consulter les colis
              - column:
                  name: resource
                  value: COLIS
              - column:
                  name: action
                  value: READ

        - insert:
            tableName: permissions
            columns:
              - column:
                  name: id
                  value: perm-002
              - column:
                  name: name
                  value: WRITE_COLIS
              - column:
                  name: description
                  value: Créer des colis
              - column:
                  name: resource
                  value: COLIS
              - column:
                  name: action
                  value: WRITE

        - insert:
            tableName: permissions
            columns:
              - column:
                  name: id
                  value: perm-003
              - column:
                  name: name
                  value: UPDATE_COLIS
              - column:
                  name: description
                  value: Modifier des colis
              - column:
                  name: resource
                  value: COLIS
              - column:
                  name: action
                  value: UPDATE

        - insert:
            tableName: permissions
            columns:
              - column:
                  name: id
                  value: perm-004
              - column:
                  name: name
                  value: DELETE_COLIS
              - column:
                  name: description
                  value: Supprimer des colis
              - column:
                  name: resource
                  value: COLIS
              - column:
                  name: action
                  value: DELETE

        - insert:
            tableName: permissions
            columns:
              - column:
                  name: id
                  value: perm-005
              - column:
                  name: name
                  value: UPDATE_STATUT_COLIS
              - column:
                  name: description
                  value: Mettre à jour le statut des colis
              - column:
                  name: resource
                  value: COLIS
              - column:
                  name: action
                  value: UPDATE_STATUT

        - insert:
            tableName: permissions
            columns:
              - column:
                  name: id
                  value: perm-006
              - column:
                  name: name
                  value: MANAGE_LIVREURS
              - column:
                  name: description
                  value: Gérer les livreurs
              - column:
                  name: resource
                  value: LIVREUR
              - column:
                  name: action
                  value: MANAGE

        - insert:
            tableName: permissions
            columns:
              - column:
                  name: id
                  value: perm-007
              - column:
                  name: name
                  value: MANAGE_ZONES
              - column:
                  name: description
                  value: Gérer les zones de livraison
              - column:
                  name: resource
                  value: ZONE
              - column:
                  name: action
                  value: MANAGE

        - insert:
            tableName: permissions
            columns:
              - column:
                  name: id
                  value: perm-008
              - column:
                  name: name
                  value: MANAGE_CLIENTS
              - column:
                  name: description
                  value: Gérer les clients expéditeurs
              - column:
                  name: resource
                  value: CLIENT
              - column:
                  name: action
                  value: MANAGE

        - insert:
            tableName: permissions
            columns:
              - column:
                  name: id
                  value: perm-009
              - column:
                  name: name
                  value: VIEW_STATISTICS
              - column:
                  name: description
                  value: Consulter les statistiques
              - column:
                  name: resource
                  value: STATISTICS
              - column:
                  name: action
                  value: READ

        # Assign permissions to MANAGER role (all permissions)
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-001
              - column:
                  name: permission_id
                  value: perm-001
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-001
              - column:
                  name: permission_id
                  value: perm-002
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-001
              - column:
                  name: permission_id
                  value: perm-003
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-001
              - column:
                  name: permission_id
                  value: perm-004
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-001
              - column:
                  name: permission_id
                  value: perm-005
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-001
              - column:
                  name: permission_id
                  value: perm-006
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-001
              - column:
                  name: permission_id
                  value: perm-007
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-001
              - column:
                  name: permission_id
                  value: perm-008
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-001
              - column:
                  name: permission_id
                  value: perm-009

        # Assign permissions to LIVREUR role
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-002
              - column:
                  name: permission_id
                  value: perm-001
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-002
              - column:
                  name: permission_id
                  value: perm-005

        # Assign permissions to CLIENT role
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-003
              - column:
                  name: permission_id
                  value: perm-001
        - insert:
            tableName: role_permissions
            columns:
              - column:
                  name: role_id
                  value: role-003
              - column:
                  name: permission_id
                  value: perm-002

        # Create default admin user
        # Password: admin123 (BCrypt encoded)
        - insert:
            tableName: users
            columns:
              - column:
                  name: id
                  value: user-admin-001
              - column:
                  name: username
                  value: admin
              - column:
                  name: email
                  value: admin@deligo.com
              - column:
                  name: password
                  value: $2a$10$3Z0zO5YRzC5WujE9BV8cDuQRbq/yp1gdaNwy5G6EsyZ6b2GFV1RHe
              - column:
                  name: nom
                  value: Administrateur
              - column:
                  name: prenom
                  value: Système
              - column:
                  name: telephone
                  value: '0600000000'
              - column:
                  name: actif
                  valueBoolean: true
              - column:
                  name: provider
                  value: LOCAL
              - column:
                  name: date_creation
                  valueDate: now()
              - column:
                  name: date_modification
                  valueDate: now()

        # Assign MANAGER role to admin
        - insert:
            tableName: user_roles
            columns:
              - column:
                  name: user_id
                  value: user-admin-001
              - column:
                  name: role_id
                  value: role-001